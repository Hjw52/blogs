(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{577:function(s,e,n){"use strict";n.r(e);var t=n(13),a=Object(t.a)({},(function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("ul",[n("li",[n("h3",{attrs:{id:"websocket特点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#websocket特点"}},[s._v("#")]),s._v(" websocket特点")]),s._v(" "),n("ul",[n("li",[s._v("双向通信技术")]),s._v(" "),n("li",[s._v("没有同源限制")]),s._v(" "),n("li",[s._v("数据分片，按帧传输（文本数据类型，二进制数据类型，控制帧类型）")])])])]),s._v(" "),n("p",[s._v("websocket就服务端推送提供了另外一种解决方案，相比HTTP1.1，它优势就在于服务端推送。他本质上是在tcp协议上封装的另一种应用层协议（websocket协议）。因为他是基于tcp的，所以服务端推送自然不是什么难题。但是在实现上，他并不是直接连接一个tcp连接，然后在上面传输基于websocket协议的数据包。他涉及到一个协议升级（交换）的过程。")]),s._v(" "),n("p",[n("strong",[s._v("客户端request格式如下：")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("GET / HTTP/1.1\nHost: localhost:8080\nOrigin: http://127.0.0.1:3000\nConnection: Upgrade\nUpgrade: websocket\nSec-WebSocket-Version: 13\nSec-WebSocket-Key: w4v7O6xFTi36lq3RNcgctw==\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[n("strong",[s._v("服务端响应协议升级：")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("HTTP/1.1 101 Switching Protocols\nConnection:Upgrade\nUpgrade: websocket\nSec-WebSocket-Accept: Oy4NRAQ13jhfONC7bP8dTKb4PTU=\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[n("strong",[s._v("服务器给浏览器推送的时候，浏览器会发送ack，但是浏览器给服务器发送的时候，服务器貌似没有返回ack？")])]),s._v(" "),n("p",[s._v("服务器（tcp）推送消息的时候把ack也带上了。而不是发送两个tcp包。这就是tcp的机制。tcp不会对每个包都发ack，他会累积确认（发ack），以减少网络的包，但是他也需要保证尽快地回复ack，否则就会导致客户端触发超时重传。tcp什么时候发送确认呢？比如需要发送数据的时候，或者超过一定时间没有收到数据包，或者累积的确认数量达到阈值等。")]),s._v(" "),n("p",[n("strong",[s._v("websocket连接持续多久？")])]),s._v(" "),n("p",[s._v("在websocket连接上，一直不通信的话，websocket连接所维持的时间是依赖tcp实现的。因为我们发现tcp层会一直发送探测包。达到阈值之后，连接就会被断开。所以我们想维持websocket连接的话，需要自己去发送心跳包，比如ping，pong。")]),s._v(" "),n("ul",[n("li",[n("h3",{attrs:{id:"webcocket数据帧结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#webcocket数据帧结构"}},[s._v("#")]),s._v(" webcocket数据帧结构")])])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://github.com/Hjw52/Blog/blob/master/image/image-20201015220950045.png?raw=true",alt:"image-20201015220950045"}})]),s._v(" "),n("p",[s._v("具体的含义如下：")]),s._v(" "),n("ol",[n("li",[s._v("**FIN：**1位，表示当前数据帧是否为最后一帧。1代表最后帧，0代表还在传输。如果消息只由一帧构成，那么起始帧就是结束帧。")]),s._v(" "),n("li",[s._v("**RSV1，RSV2，RSV3：**各1位，如果未定义拓展，那么都为0；如果定义了拓展则为非0值。如果接收的帧为非0值但拓展中没有该值的定义，那么连接关闭。")]),s._v(" "),n("li",[s._v("**opcode：**4位，为PayloadData有效负荷，如果接收到未知的opcode，关闭连接。"),n("strong",[s._v("opcode主要有以下类型")]),s._v("：\n"),n("ul",[n("li",[s._v("0x0：表示附加数据帧，延续帧")]),s._v(" "),n("li",[s._v("0x1：表示文本数据帧")]),s._v(" "),n("li",[s._v("0x2：表示二进制数据帧")]),s._v(" "),n("li",[s._v("0x3-7：暂无定义，保留")]),s._v(" "),n("li",[s._v("0x8：表示连接关闭")]),s._v(" "),n("li",[s._v("0x9：表示ping")]),s._v(" "),n("li",[s._v("0xA：表示pong，ping pong用于心跳连接，检测连接是否断开")]),s._v(" "),n("li",[s._v("0xB-F：暂无定义，保留")])])]),s._v(" "),n("li",[s._v("**MASK：**1位，用于标识PlayloadData是否经过掩码处理，如果是1，Masking-key域的数据即是掩码秘钥，用于解码PlayloadData。websocket的安全机制，从客户端向服务器传输的数据帧必须经过掩码处理，服务端若收到未经掩码处理的数据帧，则主动关闭连接（发送closed帧，状态码1002）。")]),s._v(" "),n("li",[s._v("**MASKing-key：**客户端设置得32位的随机数，掩码算法主要是：\n"),n("ul",[n("li",[s._v("origin-i：原始数据的第i字节")]),s._v(" "),n("li",[s._v("transform-i：转换后的第i字节")]),s._v(" "),n("li",[s._v("a：选取的i mod 4 位的值（掩码key只有4个字节）")]),s._v(" "),n("li",[s._v("transform-i =  origin-i XOR a 。两者异或得到掩码后的值。")])])]),s._v(" "),n("li",[n("strong",[s._v("Playload data")]),s._v("：x+y 位，包含拓展数据和应用数据。")])]),s._v(" "),n("ul",[n("li",[n("h3",{attrs:{id:"状态码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#状态码"}},[s._v("#")]),s._v(" 状态码")]),s._v(" "),n("p",[s._v("当关闭一个已建立的连接时，端点可以使用预设的状态码来解释关闭原因，主要有以下状态码：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("状态码")]),s._v(" "),n("th",[s._v("描述")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("1000")]),s._v(" "),n("td",[s._v("正常关闭")])]),s._v(" "),n("tr",[n("td",[s._v("1001")]),s._v(" "),n("td",[s._v("终端离开，可能服务端错误或客户端离开")])]),s._v(" "),n("tr",[n("td",[s._v("1002")]),s._v(" "),n("td",[s._v("协议错误")])]),s._v(" "),n("tr",[n("td",[s._v("1003")]),s._v(" "),n("td",[s._v("接收到不允许的数据类型（文本类型收到二进制数据）")])]),s._v(" "),n("tr",[n("td",[s._v("1004-1006")]),s._v(" "),n("td",[s._v("保留")])]),s._v(" "),n("tr",[n("td",[s._v("1007")]),s._v(" "),n("td",[s._v("接收到格式不符的数据（文本消息收到非utf-8)")])]),s._v(" "),n("tr",[n("td",[s._v("1008")]),s._v(" "),n("td",[s._v("收到不符数据，用于不适1003和1009场景")])]),s._v(" "),n("tr",[n("td",[s._v("1009")]),s._v(" "),n("td",[s._v("收到过大数据帧")])]),s._v(" "),n("tr",[n("td",[s._v("1011")]),s._v(" "),n("td",[s._v("客户端阻止完成请求")])]),s._v(" "),n("tr",[n("td",[s._v("1012")]),s._v(" "),n("td",[s._v("服务端重启")])])])])]),s._v(" "),n("li",[n("h3",{attrs:{id:"node构建websocket"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#node构建websocket"}},[s._v("#")]),s._v(" Node构建websocket")]),s._v(" "),n("p",[s._v("模拟浏览器切换协议")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("var WebSocket = function (url) {\n // 伪代码 解析ws://127.0.0.1:12010/updates 请求\n this.options = parseUrl(url);\n this.connect();\n};\nWebSocket.prototype.onopen = function () {\n // TODO\n};\nWebSocket.prototype.setSocket = function (socket) {\n this.socket = socket;\n};\nWebSocket.prototype.connect = function () {\n var this = that;\n var key = new Buffer(this.options.protocolVersion + '-' + Date.now()).toString('base64');\n var shasum = crypto.createHash('sha1'); \n var expected = shasum.update(key + '258EAFA5-E914-47DA-95CA-C5AB0DC85B11').digest('base64');\n var options = {\n port: this.options.port, // 12010\n host: this.options.hostname, // 127.0.0.1\n headers: {\n 'Connection': 'Upgrade',\n 'Upgrade': 'websocket',\n 'Sec-WebSocket-Version': this.options.protocolVersion,\n 'Sec-WebSocket-Key': key\n }\n };\n var req = http.request(options);\n req.end();\n req.on('upgrade', function(res, socket, upgradeHead) {\n // 连接成功\n that.setSocket(socket);\n //触发open事件\n that.onopen();\n });\n}; \n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br")])]),n("p",[s._v("服务端")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("var server = http.createServer(function (req, res) {\n res.writeHead(200, {'Content-Type': 'text/plain'});\n res.end('Hello World\\n');\n});\nserver.listen(12010);\n// 在收ڟupgrade请求ࢫǈߢኮ客户端ሎႹൎ换ၹᅱ\nserver.on('upgrade', function (req, socket, upgradeHead) {\n var head = new Buffer(upgradeHead.length);\n upgradeHead.copy(head);\n var key = req.headers['sec-websocket-key'];\n var shasum = crypto.createHash('sha1');\n key = shasum.update(key + \"258EAFA5-E914-47DA-95CA-C5AB0DC85B11\").digest('base64');\n var headers = [\n 'HTTP/1.1 101 Switching Protocols',\n 'Upgrade: websocket',\n 'Connection: Upgrade',\n 'Sec-WebSocket-Accept: ' + key,\n 'Sec-WebSocket-Protocol: ' + protocol\n ];\n // 发送数据\n socket.setNoDelay(true);\n socket.write(headers.concat('', '').join('\\r\\n'));\n // 建立服务器端WebSocket连接\n var websocket = new WebSocket();\n websocket.setSocket(socket);\n}); \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("p",[s._v("客户端")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("var socket = new WebSocket('ws://127.0.0.1:12010/updates');\n//握手完成后触发\nsocket.onopen = function () {\n setInterval(function() {\n if (socket.bufferedAmount == 0)\n socket.send(getUpdateData());\n }, 50);\n};\nsocket.onmessage = function (event) {\n // TODO：event.data\n}; \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])])]),s._v(" "),n("li",[n("h3",{attrs:{id:"兼容性"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#兼容性"}},[s._v("#")]),s._v(" 兼容性")])])]),s._v(" "),n("p",[s._v("websocket虽然功能强大，但不是所有的浏览器都能支持websocket，IE11以下的浏览器就无法使用websocket。这只能使用HTTP的轮询和长轮询（用户的扫码登录就是长轮询）来替代websocket了。")])])}),[],!1,null,null,null);e.default=a.exports}}]);